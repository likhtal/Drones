<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drone World — Map</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

  <link rel="stylesheet" type="text/css" href="css/map.css" />
  <link rel="stylesheet" type="text/css" href="css/dynamicSelect.css" >

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

  <script src="https://unpkg.com/leaflet-ajax@2.1.0/dist/leaflet.ajax.js"></script>
  <script src="https://cdn.rawgit.com/hayeswise/Leaflet.PointInPolygon/v1.0.0/wise-leaflet-pip.js"></script>

</head>
<body>
  <header>
    <h1>Drone World — Map</h1>
    <p class="lead"></p>
  </header>

  <main>
    <section class="map">
       <div id="map"></div>

       <button id="undo">Undo</button>
       <button id="launch">Launch</button>
       <button id="clear">Clear</button>


       <label for="select-drones" id="select-drones-label">Choose a drone:</label>

       <select name="select-drones" id="select-drones" data-placeholder="Select a drone" data-dynamic-select>
<!--
         <option value="1" data-img="img/drone-icon1.png">Drone #1 (2000)</option>
         ...
-->
       </select>

    </section>

    <aside class="aside">
      <h3 style="margin:0 0 8px;color:var(--accent)">Quick Links</h3>
      <nav class="navlinks" aria-label="Main navigation">
        <a href="index.html">Home</a>
        <a href="gallery.html">Gallery — Photos</a>
        <a href="about.html">About Drones</a>
        <a href="news.html">Drone News</a>
        <a href="map.html">Map</a>
      </nav>
    </aside>
  </main>
  <script src="js/util.js"></script>
  <script src="js/drones.js"></script>

  <script>
    const map = L.map('map').setView([50.450001, 30.523333], 6);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
       maxZoom: 19,
       attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
   }).addTo(map);

   const geojsonLayer = new L.GeoJSON.AJAX("https://geowebservices.stanford.edu/geoserver/wfs?service=WFS&" +
       "version=1.1.0&request=GetFeature&typename=druid:nv937bq8361&" +
       "outputFormat=application/json&srsname=EPSG:4326", {
       onEachFeature: function (feature, layer) {
           //var popupContent = '';
           //for (var key in feature.properties) {
           //    popupContent += key + ': ' + feature.properties[key] + '<br>';
           //}
           //layer.bindPopup(popupContent);
       }
   }).addTo(map);

   geojsonLayer.on('data:loaded', function () {
       map.fitBounds(geojsonLayer.getBounds());
   });

   const State = {points: [], markers: []};

   const clrBtn = document.getElementById("clear");
   const launchBtn = document.getElementById("launch");
   const undoBtn = document.getElementById("undo");

   clrBtn.addEventListener("click", function() {
      cleanUp();
   });   

   launchBtn.addEventListener("click", async function() {
      await launch();
   });   

   undoBtn.addEventListener("click", async function() {
      await undo();
   });   

   function cleanUp() {
      for (let i = 0; i < State.markers.length; i++) {
         map.removeLayer(State.markers[i]);
      }

      if (!!State.droneLine) {
         map.removeLayer(State.droneLine);
      }
      if (!!State.explosionMarker) {
         map.removeLayer(State.explosionMarker);
      }

      State.points = [];
      State.markers = [];
      State.explosionMarker = null;
      State.droneLine = null; 
      State.droneNum = null; 
      State.droneIcon = null;
   }

   async function fly(st, en) {
      const {lat: lat1, lng: lng1} = st._latlng;
      const {lat: lat2, lng: lng2} = en._latlng;

      let droneMarker;

      // w varies from 0 to 1
      for (let i=0; i < 100; i++) {  
          let w = i/100;
          let lat = lat1*(1-w) + lat2*w;
          let lng = lng1*(1-w) + lng2*w;
          await delay(DELAY);
          if (!!droneMarker) {
             map.removeLayer(droneMarker);
          }
          droneMarker = L.marker([lat, lng], {icon: State.droneIcon}).addTo(map);    
      }

      if (!!droneMarker) {  
         map.removeLayer(droneMarker);
      }
   }
   
   async function launch() {
      map.fitBounds(State.droneLine.getBounds());

      // let's check the distance 
      if (routeDistance(State.points) > LIMITS[State.droneNum]) {
         alert("The distance is too long!"); 
         cleanUp();
         return;
      }

      // start moving the drone
      if (!!State.markers[0]) {
         map.removeLayer(State.markers[0]);
      }

      for (let i = 0; i < State.markers.length-1; i++) {
         await fly(State.markers[i], State.markers[i+1]);     
      }


      const en = State.points[State.points.length-1];

      cleanUp();

      // Let's explode
      State.explosionMarker = L.marker(en, {icon: EXPLOSION_ICON}).addTo(map);    
      map.setView(en, 10);
   }  

   async function onMapClick(e) {
      State.points[State.points.length] = e.latlng; 

      if (State.points.length == 1) {  // 1st click

         // geojsonLayer.eachLayer(function(memberLayer) {
         //   console.log(memberLayer.feature.properties);
         //
         //   if (!memberLayer.contains(e.latlng)) {
         //      alert("Warning: the point is outside of the Ukrainian boundary!");
         //   }
         // });

         State.droneNum = document.querySelector('.dynamic-select-option.dynamic-select-selected').getAttribute("data-value");
         State.droneIcon = DRONES[State.droneNum];
         
         State.markers[State.markers.length] = L.marker(e.latlng, {icon: State.droneIcon}).addTo(map);    

      } else {

         for (let i = 1; i < State.markers.length; i++) {
           map.removeLayer(State.markers[i]);
         }

         State.markers[State.markers.length] = L.marker(e.latlng).addTo(map);    
      }

      if (!!State.droneLine) {
         map.removeLayer(State.droneLine);
      }

      State.droneLine = L.polyline(State.points, {color: COLOR}).addTo(map);
   }

   async function undo() {
      if (State.explosionMarker) {
        map.removeLayer(State.explosionMarker);
        State.explosionMarker = null;
        return;
      }

      if (State.markers.length > 0) {
        const lastMarker = State.markers.pop();
        if (lastMarker) map.removeLayer(lastMarker);
      }
   
      if (State.points.length > 0) {
        State.points.pop();
      }

      if (State.droneLine) {
        map.removeLayer(State.droneLine);
        State.droneLine = null;
      }
    
      if (State.points.length > 0) {
        State.droneLine = L.polyline(State.points, {color: COLOR}).addTo(map);

      } else {
        State.droneNum = null;
        State.droneIcon = null;
      }

      if (State.points.length > 1) {
         State.markers[State.markers.length-1].addTo(map);    
      }
   }

    map.on('click', onMapClick);
  </script>

  <script>
    const selectElement = document.getElementById('select-drones'); 

    for (const i in DRONES) {

       let drone = DRONES[i];  // whole object!
       let name = DRONE_NAMES[i]; 
       let limit = LIMITS[i];      // from LIMITS

       console.log(drone);
       let img = drone.options.iconUrl;

       const newOption = new Option(`${name} (${limit})`, `${i}`); 
       newOption.setAttribute('data-img', img);
       selectElement.add(newOption); 
    }

  </script>

  <script src="js/dynamicSelect.js"></script>

</body>
</html>

