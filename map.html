<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drone World — Map</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
  <link rel="stylesheet" href="css/map.css" />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

  <script src="https://unpkg.com/leaflet-ajax@2.1.0/dist/leaflet.ajax.js"></script>

</head>
<body>
  <header>
    <h1>Drone World — Map</h1>
    <p class="lead"></p>
  </header>

  <main>
    <section class="map">
       <div id="map"></div>
       <label for="select-drones" id="select-drones-label">Choose a drone:</label>
       <select name="select-drones" id="select-drones">
         <option value="1">Drone #1</option>
         <option value="2">Drone #2</option>
       </select>
       <button id="clear">Clear</button>
       <button id="launch">Launch</button>
    </section>

    <aside class="aside">
      <h3 style="margin:0 0 8px;color:var(--accent)">Quick Links</h3>
      <nav class="navlinks" aria-label="Main navigation">
        <a href="index.html">Home</a>
        <a href="gallery.html">Gallery — Photos</a>
        <a href="about.html">About Drones</a>
        <a href="news.html">Drone News</a>
        <a href="map.html">Map</a>
      </nav>
    </aside>
  </main>
  <script src="js/util.js"></script>
  <script src="js/drones.js"></script>

  <script>
    const map = L.map('map').setView([50.450001, 30.523333], 6);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
       maxZoom: 19,
       attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
   }).addTo(map);

   const geojsonLayer = new L.GeoJSON.AJAX("https://geowebservices.stanford.edu/geoserver/wfs?service=WFS&" +
       "version=1.1.0&request=GetFeature&typename=druid:nv937bq8361&" +
       "outputFormat=application/json&srsname=EPSG:4326", {
       onEachFeature: function (feature, layer) {
           //var popupContent = '';
           //for (var key in feature.properties) {
           //    popupContent += key + ': ' + feature.properties[key] + '<br>';
           //}
           //layer.bindPopup(popupContent);
       }
   }).addTo(map);

   //geojsonLayer.on('data:loaded', function () {
   //    map.fitBounds(geojsonLayer.getBounds());
   //});

   const State = {points: [], markers: []};

   const clrBtn = document.getElementById("clear");
   const launchBtn = document.getElementById("launch");

   clrBtn.addEventListener("click", function() {
      cleanUp();
   });   

   launchBtn.addEventListener("click", async function() {
      await launch();
   });   

   function cleanUp() {
      for (let i = 0; i < State.markers.length; i++) {
         map.removeLayer(State.markers[i]);
      }

      if (!!State.droneLine) {
         map.removeLayer(State.droneLine);
      }
      if (!!State.explosionMarker) {
         map.removeLayer(State.explosionMarker);
      }

      State.points = [];
      State.markers = [];
      State.explosionMarker = null;
      State.droneLine = null; 
      State.droneNum = null; 
      State.droneIcon = null;
   }

   async function fly(st, en) {
      const {lat: lat1, lng: lng1} = st._latlng;
      const {lat: lat2, lng: lng2} = en._latlng;

      let droneMarker;

      // w varies from 0 to 1
      for (let i=0; i < 100; i++) {  
          let w = i/100;
          let lat = lat1*(1-w) + lat2*w;
          let lng = lng1*(1-w) + lng2*w;
          await delay(DELAY);
          if (!!droneMarker) {
             map.removeLayer(droneMarker);
          }
          droneMarker = L.marker([lat, lng], {icon: State.droneIcon}).addTo(map);    
      }

      if (!!droneMarker) {  
         map.removeLayer(droneMarker);
      }
   }
   
   async function launch() {
      map.fitBounds(State.droneLine.getBounds());

      // let's check the distance 
      if (routeDistance(State.points) > LIMITS[State.droneNum]) {
         alert("The distance is too long!"); 
         cleanUp();
         return;
      }

      // start moving the drone
      if (!!State.markers[0]) {
         map.removeLayer(State.markers[0]);
      }

      for (let i = 0; i < State.markers.length-1; i++) {
         await fly(State.markers[i], State.markers[i+1]);     
      }


      const en = State.points[State.points.length-1];

      cleanUp();

      // Let's explode
      State.explosionMarker = L.marker(en, {icon: EXPLOSION_ICON}).addTo(map);    
   }  

   async function onMapClick(e) {
      State.points[State.points.length] = e.latlng; 

      if (State.points.length == 1) {  // 1st click
         State.droneNum = document.getElementById("select-drones").value;
      
         if (State.droneNum == 2) {
           State.droneIcon = DRONE_ICON2;
         } else {
           State.droneIcon = DRONE_ICON1;
         }

         State.markers[State.markers.length] = L.marker(e.latlng, {icon: State.droneIcon}).addTo(map);    

      } else {

         for (let i = 1; i < State.markers.length; i++) {
           map.removeLayer(State.markers[i]);
         }

         State.markers[State.markers.length] = L.marker(e.latlng).addTo(map);    
      }

      if (!!State.droneLine) {
         map.removeLayer(State.droneLine);
      }

      State.droneLine = L.polyline(State.points, {color: COLOR}).addTo(map);
   }

    map.on('click', onMapClick);
  </script>
</body>
</html>

